DECLARE
SSS VARCHAR2(32000):='<?xml version="1.0" encoding="windows-1251"?>
<UZ-XDOC schema="uzvp" doc_version="1.0" doc_type="data" subtype="normal">
<HEAD messcode="LM012" from="change" password="tiger" id_node_src="6314501300" id_ev_node_src="5470901000000015" />
<BODY>
<MM type_mm="2" idf_emm="" code_op="12" idf_mm="" kpz="4501" nom_mrm="1602009" ozn_mm="1" date_mm="27.03.2018" date_calc="29.03.2018" kod_kol="1" kop="" ozn_poizdky="">
<BRIG depo="4501" type_rab="2" type_obj_javka="201" code_obj_javka="450022" javka="27.03.2018 19:20" priem="27.03.2018 19:20" sd_lok="27.03.2018 22:00" end_rab="27.03.2018 22:00" id_depo_out="" depo_out="" tip_inf_depo_out="" id_depo_in="4501" depo_in="27.03.2018 21:20" tip_inf_depo_in="" otdyh="" type_obj_end_rab="205" code_obj_end_rab="4501">
<BRIG_PERSON idf_brig="11449239277" depo_prip="4501" tab_brig="1444" fam_brig="Ліхачов" dolg_brig="0" dolg_mm="1" date_beg_rab="27.03.2018 19:20" date_end_rab="27.03.2018 22:00" />
<BRIG_PERSON idf_brig="760412369" depo_prip="4501" tab_brig="1127" fam_brig="Голуб" dolg_brig="0" dolg_mm="2" date_beg_rab="27.03.2018 19:20" date_end_rab="27.03.2018 22:00" />
</BRIG>
<LOK idf_tps="13231911077" pr_sec="0" kod_ser="530" name_lok="1423 " depo_lok="4501" cnt_sek="" ozn_taks="1" idf_tps_sbo="" priem="27.03.2018 19:20" priem_end="27.03.2018 19:20" sd_lok_beg="27.03.2018 22:00" sd_lok="27.03.2018 22:00" id_depo_out="" depo_out="" id_depo_in="" depo_in="27.03.2018 21:20">
<SEC idf_sec="174197957" nom_lok="1423" kod_sek="1" sdacha_pred="27.03.2018 19:20" el_kod_scheme="" ozn_p="" ozn_zm="" ozn_op="" ozn_rec="" ozn_tyjga="0">
<PER date_zam="27.03.2018 19:20" op_zam="1" lich_p="" lich_zm="" lich_rec="" lich_op="" topl_l="2863" topl_kg="2419.235" mas_l="1230" mas_kg="1136.520" temperature="" t_shif_top_s="" t_nom_sut_n="" mas_shif_top_s="" mas_nom_sut_n="" t_koef="0.845" m_koef="0.924" />
<PER date_zam="27.03.2018 19:20" op_zam="2" lich_p="" lich_zm="" lich_rec="" lich_op="" topl_l="2863" topl_kg="2419.235" mas_l="1230" mas_kg="1136.520" temperature="" t_shif_top_s="" t_nom_sut_n="" mas_shif_top_s="" mas_nom_sut_n="" t_koef="0.845" m_koef="0.924" />
<PER date_zam="27.03.2018 22:00" op_zam="3" lich_p="" lich_zm="" lich_rec="" lich_op="" topl_l="2862" topl_kg="2418.390" mas_l="1230" mas_kg="1136.520" temperature="" t_shif_top_s="" t_nom_sut_n="" mas_shif_top_s="" mas_nom_sut_n="" t_koef="0.845" m_koef="0.924" />
</SEC>
<SEC idf_sec="174197958" nom_lok="1423" kod_sek="2" sdacha_pred="" el_kod_scheme="" ozn_p="" ozn_zm="" ozn_op="" ozn_rec="" ozn_tyjga="0">
<PER date_zam="27.03.2018 19:20" op_zam="1" lich_p="" lich_zm="" lich_rec="" lich_op="" topl_l="1875" topl_kg="1584.375" mas_l="1220" mas_kg="1127.280" temperature="" t_shif_top_s="" t_nom_sut_n="" mas_shif_top_s="" mas_nom_sut_n="" t_koef="0.845" m_koef="0.924" />
<PER date_zam="27.03.2018 19:20" op_zam="2" lich_p="" lich_zm="" lich_rec="" lich_op="" topl_l="1875" topl_kg="1584.375" mas_l="1220" mas_kg="1127.280" temperature="" t_shif_top_s="" t_nom_sut_n="" mas_shif_top_s="" mas_nom_sut_n="" t_koef="0.845" m_koef="0.924" />
<PER date_zam="27.03.2018 22:00" op_zam="3" lich_p="" lich_zm="" lich_rec="" lich_op="" topl_l="1801" topl_kg="1521.845" mas_l="1220" mas_kg="1127.280" temperature="" t_shif_top_s="" t_nom_sut_n="" mas_shif_top_s="" mas_nom_sut_n="" t_koef="0.845" m_koef="0.924" />
</SEC>
<VID_SLED sdate_beg="27.03.2018 20:25" sdate_end="27.03.2018 20:38" str_nom_beg="1" str_nom_end="2" kod_sled_okdl="4" />
</LOK>
<WORK_MM str_nom="1" pr_rab="0" type_obj_disl="" esr="450022" kod_work="" nom_park="" nach="" konec="27.03.2018 20:25" p_man_stay_teh ="" stay_ogid_rab="" stay_ogid_dv="" tip_inf_pr="" tip_inf_otpr="" />
<WORK_MM str_nom="2" pr_rab="0" type_obj_disl="" esr="450003" kod_work="" nom_park="" nach="27.03.2018 20:38" konec="" p_man_stay_teh ="" stay_ogid_rab="" stay_ogid_dv="" tip_inf_pr="" tip_inf_otpr="" />
<POIZD_MM sdate_beg="27.03.2018 20:25" sdate_end="27.03.2018 20:38" str_nom_beg="1" str_nom_end="2" nom_pok="1" idf_poizd="" nom_p="4704" rod_p="72" vid_ruxu="41" esr_form="" ord_num="" esr_nazn="" netto="" brutto="" vs_vag="" ozn_nav_poizd="" ozn_malopot="" />
</MM>
</BODY>
</UZ-XDOC>';
V1 VARCHAR2(20):='(11 3233 3)53';
V2 VARCHAR2(20):='114503042';
RETMETKA NUMBER;
BEGIN
  UZXDOC.XMLMASTER_V2.PROCESSING (SSS, V1, V2);
END; 




INSERT INTO S_TMP_TAKSUV (NOMMAR_ID,
                                NOMMAR,
                                LINDIST,
                                FACTTIME,
                                PRST,
                                MANST,
                                DATEMOD                   --------------------
                                       ,
                                PALFACT,
                                PALNORMA,
                                RECUPER,
                                TKMWORKNETO,
                                TKMWORKBRYTO,
                                PRPROMST,
                                PROBOROTST,
                                PRZMINABRGST,
                                PRPRYPDEPO                              ------
                                          ,
                                PROBOROTDEPO,
                                MANPROMST,
                                MANOBOROTST,
                                MANPRYPST,
                                KILKPROMST,
                                VYTRDEPOKG,
                                VYTRDEPOL,
                                PALNORMAL,
                                PROSTVHSVITL,
                                NEPTIME,
                                KOLPRVHSV,
                                KODSERLOK,
                                NOMLOK,
                                OPAL,
                                OPAL_ZM,
                                POGRAN,
                                POGRAN_ZM,
                                NAGINALL,
                                KODDOR1,
                                FAKT_DOR1,
                                DATE_1,
                                palfactl)
         (  SELECT a.IDF_MM,
                   a.NOM_MRM,
                   SUM (B.LOK_KM / 1000),
                   LPAD (SUM (ROUND ( (B.VR_FACT / 60), 2)), 5, '0'),
                   LPAD (
                      SUM (
                         ROUND (
                            (  (  B.PR_PROST
                                + B.PRIP_PROST
                                + B.ST_OB_PROST --+ b.dep_prip_prost
                                + B.SM_BR_PROST)
                             / 60),
                            2)),
                      5,
                      '0'),
                   LPAD (
                      SUM (
                         ROUND (
                            ( (B.MAN_PR_ST + B.MAN_ST_OB + B.MAN_ST_PRIP) / 60),
                            2)),
                      5,
                      '0'),
                   TRUNC (a.DATE_OP, 'dd')         ---------------------------
                                          ,
                   DECODE (e.fact, NULL, 00.00, e.fact),
                   DECODE (e.norm, NULL, 0, e.norm),
                   0                                   -----------------------
                    ,
                   LPAD (SUM (b.tkm_netto), 5, '0'),
                   LPAD (SUM (b.tkm_brutto), 5, '0'),
                   LPAD (SUM (ROUND ( (b.pr_prost / 60), 2)), 5, '0') --TO_CHAR( a.JAVKA, 'hh24:mi' )
                                                                     ,
                   LPAD (SUM (ROUND ( (b.prip_prost / 60), 2)), 5, '0') --TO_CHAR( a.JAVKA, 'hh24:mi' )
                                                                       ,
                   DECODE (
                      SUM (ROUND ( (b.st_ob_prost / 60), 2)),
                      0, '00.00',
                      NULL, '00.00',
                      LPAD (SUM (ROUND ( (b.st_ob_prost / 60), 2)), 5, '0')) --TO_CHAR( a.JAVKA, 'hh24:mi' )
                                                                            ,
                   DECODE (
                      SUM (ROUND ( (b.sm_br_prost / 60), 2)),
                      0, '00.00',
                      NULL, '00.00',
                      LPAD (SUM (ROUND ( (b.sm_br_prost / 60), 2)), 5, '0')) --TO_CHAR( a.JAVKA, 'hh24:mi' )
                                                                            ,
                   DECODE (
                      SUM (ROUND ( (b.dep_prip_prost / 60), 2)),
                      0, '00.00',
                      NULL, '00.00',
                      LPAD (SUM (ROUND ( (b.dep_prip_prost / 60), 2)), 5, '0')) --TO_CHAR( a.JAVKA, 'hh24:mi' )
                                                                               ,
                   DECODE (
                      SUM (ROUND ( (b.dep_ob_prost / 60), 2)),
                      0, '00.00',
                      NULL, '00.00',
                      LPAD (SUM (ROUND ( (b.dep_ob_prost / 60), 2)), 5, '0')) --TO_CHAR( a.JAVKA, 'hh24:mi' )
                                                                             ,
                   DECODE (SUM (ROUND ( (b.man_pr_st / 60), 2)),
                           0, '00.00',
                           NULL, '00.00',
                           LPAD (SUM (ROUND ( (b.man_pr_st / 60), 2)), 5, '0')) --TO_CHAR( a.JAVKA, 'hh24:mi' )
                                                                               ,
                   DECODE (SUM (ROUND ( (b.man_st_ob / 60), 2)),
                           0, '00.00',
                           NULL, '00.00',
                           LPAD (SUM (ROUND ( (b.man_st_ob / 60), 2)), 5, '0')) --TO_CHAR( a.JAVKA, 'hh24:mi' )
                                                                               ,
                   DECODE (
                      SUM (ROUND ( (b.man_st_prip / 60), 2)),
                      0, '00.00',
                      NULL, '00.00',
                      LPAD (SUM (ROUND ( (b.man_st_prip / 60), 2)), 5, '0')),
                   LPAD (SUM (ROUND ( (b.pr_prost / 60), 2)), 5, '0'), --g.prpromst_r7,
                   0,
                   e.norm,
                   DECODE (k.STAY_OGID_RAB, NULL, '00:00', k.STAY_OGID_RAB),
                   0,
                   k.STAY_OGID_RAB1,
                   C.KODSERLOK,
                   C.NOMLOK1,
                   0,
                   0,
                   0,
                   0,
                   0,
                   45,
                   35.00,
                   a.JAVKA,
                   e.fact
              FROM S_ITF_MAIN_MM a,
                   ASKVP_VIEW.V_EMM_TAKS_RAB B,
                   S_TMP_R1_BASE C,
                   s_st_per_mm_mm e,
                   (  SELECT SUM (k.STAY_OGID_RAB) AS STAY_OGID_RAB,
                             SUM (DECODE (k.STAY_OGID_RAB,  0, 1,  NULL, 1,  0))
                                AS STAY_OGID_RAB1,
                             k.idf_doc
                        FROM s_SUBS_RABOTA_PM_MM k, S_ITF_MAIN_MM a
                       WHERE k.idf_doc = a.idf_mm
                    GROUP BY k.idf_doc) k
             WHERE     B.idf_doc = a.idf_mm
                   AND e.idf_mm = a.IDF_MM
                   AND k.idf_doc = a.idf_mm
          GROUP BY a.IDF_MM,
                   a.NOM_MRM,
                   a.DATE_OP,
                   C.KODSERLOK,
                   C.NOMLOK1,
                   a.JAVKA,
                   e.fact,
                   e.norm,
                   k.STAY_OGID_RAB,
                   k.STAY_OGID_RAB1);

