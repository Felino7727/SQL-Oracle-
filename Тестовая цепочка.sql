DECLARE
SSS VARCHAR2(32000):='<?xml version="1.0" encoding="windows-1251" standalone="yes" ?>
<UZ-XDOC schema="uzvp" doc_version="1.0" doc_type="data" subtype="addition"> 
<HEAD messcode="LM002" from="change" password="tiger" ARM_version="23.05.2017"/>
<BODY> <MM kpz="4501" kod_kol="1" nom="2007650" kop= "6886" date="02.05.2018" date_end="03.05.2018" depo="4501" depo_prip_mash="4501" tab_mash="1220" dolg_pr_mash="0" depo_prip_pom="4501" tab_pom="1356" dolg_pr_pom="0"
lok_id_ser="1218" lok_nom="231" lok_kod_sek="0" depo_lok="4501"
javka="02.05.2018 08.55" priem="02.05.2018 09.20" sdacha_pred="02.05.2018 09.43" depo_out="" id_depo_out="" depo_in="" id_depo_in="" sd_lok="02.05.2018 20.25" end_rab="02.05.2018 20.45" prosled_st_pred="02.05.2018 09.43" temperature="0" otdyh="" 
>
<LOK id_ser="1218" nom_lok="1311" kod_sek="0" depo_lok="4501" work_st_code="4" st_nom_beg="3" st_nom_end="4" sdacha_pred="02.05.2018 10.14"/>
<LOK id_ser="1218" nom_lok="336" kod_sek="0" depo_lok="4501" work_st_code="4" st_nom_beg="7" st_nom_end="8" sdacha_pred="02.05.2018 13.28"/>
<SEC id_ser="1218" nomlok="231" kod_sek="0"><ELECTR type="2" prin_pred_brig="4404" prin_gor_progr="0" prin_beg="4404" sd_end="4478"/>
</SEC>
<WORK pr_rab="0" esr_op="450003" beg_time="" end_time="02.05.2018 09.45" nom_tr_kod_work="2029" rod_r_nom_park="10" netto_probeg="3994" brutto_vagony="4969" osi="216"
><P_RPS kod_rps="60" kol_gr="54" kol_por="0"/>
</WORK>
<WORK pr_rab="0" esr_op="450605" beg_time="02.05.2018 09.54" end_time="02.05.2018 09.54"
>
</WORK>
<WORK pr_rab="0" esr_op="451100" beg_time="02.05.2018 10.02" end_time="02.05.2018 10.14" nom_tr_kod_work="2029" rod_r_nom_park="10" netto_probeg="3994" brutto_vagony="4969" osi="216"
><P_RPS kod_rps="60" kol_gr="54" kol_por="0"/>
</WORK>
<WORK pr_rab="0" esr_op="451504" beg_time="02.05.2018 10.36" end_time="02.05.2018 11.58" nom_tr_kod_work="2609" rod_r_nom_park="10" netto_probeg="3738" brutto_vagony="5000" osi="220"
><P_RPS kod_rps="60" kol_gr="55" kol_por="0"/>
</WORK>
<WORK pr_rab="0" esr_op="456103" beg_time="02.05.2018 12.32" end_time="02.05.2018 12.32"
>
</WORK>
<WORK pr_rab="0" esr_op="456404" beg_time="02.05.2018 12.55" end_time="02.05.2018 12.55"
>
</WORK>
<WORK pr_rab="0" esr_op="456601" beg_time="02.05.2018 13.20" end_time="02.05.2018 13.28" nom_tr_kod_work="2609" rod_r_nom_park="10" netto_probeg="3738" brutto_vagony="5000" osi="220"
><P_RPS kod_rps="60" kol_gr="55" kol_por="0"/>
</WORK>
<WORK pr_rab="0" esr_op="456635" beg_time="02.05.2018 13.45" end_time="02.05.2018 13.45"
>
</WORK>
<WORK pr_rab="0" esr_op="456809" beg_time="02.05.2018 13.48" end_time="02.05.2018 13.55"
>
</WORK>
<WORK pr_rab="0" esr_op="456828" beg_time="02.05.2018 14.00" end_time="02.05.2018 15.18" nom_tr_kod_work="2852" rod_r_nom_park="10" netto_probeg="2251" brutto_vagony="3629" osi="240"
><P_RPS kod_rps="20" kol_gr="1" kol_por="0"/>
<P_RPS kod_rps="60" kol_gr="26" kol_por="11"/>
<P_RPS kod_rps="70" kol_gr="0" kol_por="6"/>
<P_RPS kod_rps="90" kol_gr="9" kol_por="7"/>
</WORK>
<WORK pr_rab="0" esr_op="456809" beg_time="02.05.2018 15.30" end_time="02.05.2018 16.18" nom_tr_kod_work="2810" rod_r_nom_park="10" netto_probeg="2119" brutto_vagony="3405" osi="220"
><P_RPS kod_rps="20" kol_gr="1" kol_por="0"/>
<P_RPS kod_rps="60" kol_gr="24" kol_por="9"/>
<P_RPS kod_rps="70" kol_gr="0" kol_por="6"/>
<P_RPS kod_rps="90" kol_gr="8" kol_por="7"/>
</WORK>
<WORK pr_rab="0" esr_op="456404" beg_time="02.05.2018 17.11" end_time="02.05.2018 17.11"
>
</WORK>
<WORK pr_rab="0" esr_op="456103" beg_time="02.05.2018 17.48" end_time="02.05.2018 17.48"
>
</WORK>
<WORK pr_rab="0" esr_op="451504" beg_time="02.05.2018 18.17" end_time="02.05.2018 18.17"
>
</WORK>
<WORK pr_rab="0" esr_op="450200" beg_time="02.05.2018 18.42" end_time="02.05.2018 19.10"
>
</WORK>
<WORK pr_rab="0" esr_op="450022" beg_time="02.05.2018 19.22" end_time="02.05.2018 19.22"
>
</WORK>
<WORK pr_rab="0" esr_op="450003" beg_time="02.05.2018 19. 32" end_time="" p_man_stay_teh="00.10"
>
</WORK>
<PRIMIT kod_prim="51" dodat1="" dodat2="" dodat3=""/>
</MM>
</BODY>
</UZ-XDOC>
  ';
A1 VARCHAR2(20):='(11 4301 0)81';
A2 VARCHAR2(20):='(11 4301 0)00';
RETMETKA NUMBER;
BEGIN
  ROLLBACK;
  -- Запуск обработки. Не менять.
  appl_dbw.S_KV_UVP_TOOLS.INITCHAIN(SSS,A1,A2);
  dbms_output.put_line('DOCTYPE='||APPL_DBW.S_KV_UVP_TOOLS.G_MSG.DOCTYPE);
  -- Вызов самой цепочки. Вместо 0 подставляется начальная метка, вместо 173 - та метка, после которой остановиться.
  -- можно оставить 0, тогда цепочка выполняется с начала. Метка конца может быть несуществующей. 
  -- Тогда останов будет после ближайшей меньшей метки   
  appl_dbw.S_KV_UVP_TOOLS.CALLCHAINEX(appl_dbw.S_KV_UVP_TOOLS.G_MSG,APPL_DBW.S_KV_UVP_TOOLS.G_MSG.DOCTYPE,0,7845,RETMETKA);
  dbms_output.put_line('ВЫХОД ИЗ ЦЕПОЧКИ НА МЕТКУ '||RETMETKA);
EXCEPTION WHEN OTHERS THEN
  NULL;
END; 

-- Этот скрипт запускать для продолжения выполнения цепочки. Метки начала и нового останова задайте вместо 9000 и 9999.
-- Метка начала выполнения может быть не той, на которой был останов. Тогда часть программ будет пропущена или выполнена дважды. 
declare
RETMETKA NUMBER;
begin
  appl_dbw.S_KV_UVP_TOOLS.CALLCHAINEX(appl_dbw.S_KV_UVP_TOOLS.G_MSG,APPL_DBW.S_KV_UVP_TOOLS.G_MSG.DOCTYPE,5640,5650,RETMETKA);
  dbms_output.put_line('ВЫХОД ИЗ ЦЕПОЧКИ НА МЕТКУ '||RETMETKA);  
end;

-- Этот скрипт обязательно вызывайте в конце отладки. Он правильно регистрирует сообщение в регистраторе.
declare
A1 VARCHAR2(20):='(11 4301 0)81';
A2 VARCHAR2(20):='(11 4301 0)00';
begin
  ROLLBACK;  
  appl_dbw.S_KV_UVP_TOOLS.EXITCHAIN(A1,A2);
EXCEPTION WHEN OTHERS THEN
    NULL;
END; 



select LPAD (TO_CHAR (S_NUMBER_SEQ.NEXTVAL), 8, '0') from dual;




SELECT                    
                   -- DECODE (MM_.OZN_MM,  1, 0,  2, 2 /*DBMS_RANDOM.VALUE( 1, 9 )*/
                   --                                 )          --Ознака ЗЛБ ММ
                     --                                ,
                    1,
                    1                       --DECODE( a.IDF_TAKS, NULL, 0, 1 )
                     ,
                    0                       --DECODE( a.STATUS,  0, 0,  1, 1 )
                     ,
                    1,
                    1                                                  --,NULL
                     ,                
                    0,
                    0,
                    0,
                    0
               FROM S_ITF_MAIN_MM a
              WHERE DATA_SOURCE = 0